<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BES Admin</title>
  <style>
    :root{
      --bg:#0b1220;
      --muted:#a7b0c0;
      --txt:#e9eef8;
      --line: rgba(255,255,255,.10);
      --good:#2E7D32;
      --warn:#FFC107;
      --bad:#D32F2F;
      --btn:#1b2a4a;
      --btn2:#22355e;
      --radius:16px;
      --shadow: 0 12px 32px rgba(0,0,0,.35);

      --newRow: rgba(255,193,7,.12);
      --recvRow: rgba(255,193,7,.08);
      --workRow: rgba(46,125,50,.07);
      --cancelRow: rgba(211,47,47,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(255,193,7,.12), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(211,47,47,.10), transparent 55%),
        var(--bg);
      color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:50;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(11,18,32,.85);
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:1200px;margin:auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sp{justify-content:space-between}
    .brand{font-weight:1000;letter-spacing:1px}
    .pill{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted);font-weight:800;font-size:12px}

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;border-radius:999px;
      font-weight:900;cursor:pointer;
    }
    .tab.active{background: linear-gradient(90deg, rgba(255,193,7,.25), rgba(255,152,0,.15)); border-color: rgba(255,193,7,.25)}

    .btn{
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--txt);
      padding:10px 12px;border-radius:12px;
      font-weight:900;cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{background:var(--btn2)}
    .btn.good{background:rgba(46,125,50,.18);border-color:rgba(46,125,50,.28)}
    .btn.warn{background:rgba(255,193,7,.18);border-color:rgba(255,193,7,.28)}
    .btn.bad{background:rgba(211,47,47,.18);border-color:rgba(211,47,47,.28)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .content{padding:14px}
    input,select,textarea{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;text-align:left}

    .muted{color:var(--muted);font-size:13px}
    .toast{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(46,125,50,.25);background:rgba(46,125,50,.12);color:rgba(185,255,210,.95);font-weight:900}
    .err{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(211,47,47,.25);background:rgba(211,47,47,.12);color:rgba(255,200,200,.95);font-weight:900}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-weight:900;font-size:12px}
    .badge.good{border-color:rgba(46,125,50,.35);color:rgba(185,255,210,.95)}
    .badge.bad{border-color:rgba(211,47,47,.35);color:rgba(255,200,200,.95)}
    .badge.warn{border-color:rgba(255,193,7,.35);color:rgba(255,240,200,.95)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .grid{display:grid;grid-template-columns: 2fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .menuGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:560px){.menuGrid{grid-template-columns:1fr}}

    .prod{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.05);
      padding:10px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .mini{
      padding:8px 10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--txt);font-weight:900;cursor:pointer;
    }

    /* ✅ Highlight commandes */
    tr.is-new td{ background: var(--newRow); }
    tr.is-received td{ background: var(--recvRow); }
    tr.is-working td{ background: var(--workRow); }
    tr.is-cancel td{ background: var(--cancelRow); }
    tr.is-new td{ animation: flash 1.2s ease-in-out 2; }
    @keyframes flash{
      0%{ filter:brightness(1.05); }
      50%{ filter:brightness(1.25); }
      100%{ filter:brightness(1.05); }
    }

    .twoCol{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media(max-width:700px){.twoCol{grid-template-columns:1fr}}
    .small{font-size:12px}

    .noteBar{
      border:1px solid rgba(255,193,7,.25);
      background: rgba(255,193,7,.10);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      margin-bottom:12px;
      display:none;
    }

    /* ✅ checkbox livré */
    .deliveredBox{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      font-weight:900;
    }
    .deliveredBox input{
      width:18px;height:18px;
      accent-color: #2E7D32;
    }
    .idCell{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New";
      font-size:12px;
      color: rgba(233,238,248,.9);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap row sp">
    <div class="row">
      <div class="brand">BES Admin</div>
      <div class="pill">Admin v2 • POS 80mm</div>
    </div>
    <div class="row">
      <button class="btn" id="refreshBtn" type="button">Actualiser</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="cardHead">
      <div class="tabs">
        <button class="tab active" data-tab="orders">Commandes</button>
        <button class="tab" data-tab="products">Produits</button>
        <button class="tab" data-tab="place">Placer une commande</button>
      </div>

      <div class="row" style="flex:1;justify-content:flex-end">
        <input id="adminKey" placeholder="ADMIN KEY (auto)" style="max-width:340px" />

        <!-- ✅ Recherche ID commande -->
        <input id="orderIdSearch" placeholder="Recherche ID commande…" style="max-width:260px" />

        <select id="statusFilter" style="max-width:240px">
          <option value="">Tous statuts</option>
          <option>Reçue</option>
          <option>Prêt à consommer</option>
          <option>Prêt à emporter</option>
          <option>Prêt à livrer</option>
          <option>Livré</option>
          <option>Annuler</option>
        </select>
      </div>
    </div>

    <div class="content">
      <div id="toast" class="toast"></div>
      <div id="err" class="err"></div>

      <!-- ORDERS -->
      <section id="tab-orders">
        <div class="card">
          <div class="content" style="padding:0">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>ID</th>
                  <th>Client</th>
                  <th>Type</th>
                  <th>Commande</th>
                  <th>Total</th>
                  <th>Statut</th>
                  <th>Livré</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="9" class="muted">Chargement…</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="muted small" style="margin-top:10px">
          Astuce: les nouvelles commandes (non vues) apparaissent en <b>jaune</b>.
          Les commandes <b>Livré</b> descendent automatiquement en bas.
        </div>
      </section>

      <!-- PRODUCTS -->
      <section id="tab-products" style="display:none">
        <!-- (inchangé) -->
        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <b>Produits</b>
              <div class="row">
                <button class="btn" id="reloadProductsBtn" type="button">Recharger</button>
              </div>
            </div>
            <div class="content" id="productsBox" class="muted">Chargement…</div>
          </div>

          <div class="card">
            <div class="cardHead">
              <b>Ajouter / Modifier</b>
              <div class="row">
                <button class="btn warn" id="reloadCatsBtn" type="button">Catégories</button>
              </div>
            </div>
            <div class="content">
              <!-- (inchangé) -->
              <div class="twoCol">
                <div>
                  <label class="small muted">ProductID</label>
                  <input id="pf_id" placeholder="Ex: 10" />
                </div>
                <div>
                  <label class="small muted">Nom</label>
                  <input id="pf_name" placeholder="Ex: Burger BES" />
                </div>
              </div>

              <div class="twoCol" style="margin-top:10px">
                <div>
                  <label class="small muted">Catégorie (choisir)</label>
                  <select id="pf_catSelect"></select>
                </div>
                <div>
                  <label class="small muted">Catégorie (nouvelle)</label>
                  <input id="pf_catNew" placeholder="Ex: Boisson" />
                </div>
              </div>

              <div class="twoCol" style="margin-top:10px">
                <div>
                  <label class="small muted">Prix (HTG)</label>
                  <input id="pf_price" type="number" step="0.01" placeholder="Ex: 250" />
                </div>
                <div>
                  <label class="small muted">Stock</label>
                  <input id="pf_stock" type="number" step="1" placeholder="Ex: 20" />
                </div>
              </div>

              <div class="twoCol" style="margin-top:10px">
                <div>
                  <label class="small muted">Ordre (optionnel)</label>
                  <input id="pf_order" type="number" step="1" placeholder="Ex: 1" />
                </div>
                <div>
                  <label class="small muted">Actif</label>
                  <select id="pf_active">
                    <option value="TRUE">TRUE (actif)</option>
                    <option value="FALSE">FALSE (désactivé)</option>
                  </select>
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <button class="btn good" id="saveProductBtn" type="button">Enregistrer</button>
                <button class="btn" id="fillFromSelectedBtn" type="button">Remplir depuis liste</button>
                <button class="btn bad" id="clearFormBtn" type="button">Vider</button>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div style="flex:1">
                  <label class="small muted">Ajuster stock rapide (ProductID)</label>
                  <input id="stock_pid" placeholder="Ex: 10" />
                </div>
                <div style="width:160px">
                  <label class="small muted">Nouveau stock</label>
                  <input id="stock_value" type="number" step="1" placeholder="Ex: 0" />
                </div>
                <div style="width:160px">
                  <label class="small muted">&nbsp;</label>
                  <button class="btn warn" id="setStockBtn" type="button">Mettre</button>
                </div>
              </div>

              <div class="muted small" style="margin-top:8px">
                Note: si Stock = 0 → le produit ne sort pas côté client.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PLACE ORDER -->
      <section id="tab-place" style="display:none">
        <!-- (inchangé) -->
        <div id="deliveryWarn" class="noteBar">Zone de livraison obligatoire</div>
        <div class="grid">
          <div class="card">
            <div class="cardHead">
              <b>Menu (stock > 0)</b>
              <div class="row">
                <button class="btn" type="button" id="reloadMenuBtn">Recharger</button>
              </div>
            </div>
            <div class="content">
              <input id="menuSearch" placeholder="Recherche…" />
              <div class="hr"></div>
              <div id="menuBox" class="muted">Chargement…</div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <b>Panier (vente)</b>
              <button class="btn bad" type="button" id="clearPlaceCartBtn">Vider</button>
            </div>
            <div class="content">
              <!-- (inchangé) -->
              <div class="row" style="margin-bottom:10px">
                <div style="flex:1">
                  <label>Nom</label>
                  <input id="p_name" placeholder="Ex: Client comptoir" />
                </div>
                <div style="flex:1">
                  <label>Téléphone</label>
                  <input id="p_phone" placeholder="Ex: +509..." />
                </div>
              </div>

              <div class="row" style="margin-bottom:10px">
                <div style="flex:1">
                  <label>Type de commande</label>
                  <select id="p_type">
                    <option>Sur place</option>
                    <option>À emporter</option>
                    <option>Livraison</option>
                  </select>
                </div>
                <div style="flex:1">
                  <label>Paiement (obligatoire)</label>
                  <select id="p_pay">
                    <option value="">Choisir…</option>
                    <option value="Cash">Cash</option>
                    <option value="Moncash">Moncash</option>
                    <option value="Natcash">Natcash</option>
                    <option value="Crédit">Crédit</option>
                  </select>
                </div>
              </div>

              <div id="p_delWrap" style="display:none;margin-bottom:10px">
                <label>Zone de livraison</label>
                <select id="p_zone">
                  <option value="">Choisir la zone…</option>
                  <option value="Centre ville Madeline">Centre ville Madeline — 250.00 HTG</option>
                  <option value="Centre ville -Barrière Bouteille">Centre ville -Barrière Bouteille — 250.00 HTG</option>
                  <option value="Centre ville - Haut du Cap">Centre ville - Haut du Cap — 350.00 HTG</option>
                  <option value="Centre ville- Quartier Morin">Centre ville- Quartier Morin — 350.00 HTG</option>
                  <option value="Centre ville - Morne rouge">Centre ville - Morne rouge — 500.00 HTG</option>
                  <option value="Centre ville - Limonade">Centre ville - Limonade — 500.00 HTG</option>
                </select>

                <div style="height:10px"></div>
                <label>Adresse (livraison)</label>
                <textarea id="p_addr" placeholder="Adresse…"></textarea>
              </div>

              <label>Note (optionnel)</label>
              <textarea id="p_note" placeholder="Ex: sans piment…"></textarea>

              <div class="hr"></div>
              <div id="placeCartItems" class="muted">Panier vide</div>

              <div class="hr"></div>

              <div class="row sp">
                <div>
                  <b>Total</b>
                  <div class="muted small" id="placeFeesInfo" style="margin-top:2px"></div>
                </div>
                <b id="placeTotal">0.00 HTG</b>
              </div>

              <div style="margin-top:12px">
                <button class="btn good" type="button" id="placeOrderBtn" disabled>Enregistrer (Sheets)</button>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
/***************
 * CONFIG
 ***************/
const API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec";
const DEFAULT_COUNTRY_CODE = "509";
const DEFAULT_ADMIN_KEY = "bes_admin_06070048094439";
const LS_ADMIN_KEY = "bes_admin_key";

/***************
 * Livraison: frais par zone
 ***************/
const DELIVERY_FEES = {
  "Centre ville Madeline": 250,
  "Centre ville -Barrière Bouteille": 250,
  "Centre ville - Haut du Cap": 350,
  "Centre ville- Quartier Morin": 350,
  "Centre ville - Morne rouge": 500,
  "Centre ville - Limonade": 500,
};

function getDeliveryFee(){
  const isLiv = norm($("p_type").value)==="livraison";
  if(!isLiv) return 0;
  const z = $("p_zone").value.trim();
  return Number(DELIVERY_FEES[z] || 0);
}

/***************
 * JSONP helper
 ***************/
function apiJsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    if(!API_URL){
      reject(new Error("API_URL manquant."));
      return;
    }
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const q = new URLSearchParams({ action, callback: cb, ...params }).toString();
    const url = API_URL + "?" + q;

    const s = document.createElement("script");
    s.src = url;
    s.async = true;

    let done = false;
    const timer = setTimeout(()=> {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout API"));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cb]; } catch(e){}
      try { s.remove(); } catch(e){}
    }

    window[cb] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("API error"));
    };

    document.head.appendChild(s);
  });
}

/***************
 * UI helpers
 ***************/
const $ = (id)=>document.getElementById(id);

function toast(msg){
  $("toast").style.display="block";
  $("toast").textContent=String(msg||"");
  setTimeout(()=>{$("toast").style.display="none";}, 3500);
}
function showErr(msg){
  $("err").style.display="block";
  $("err").textContent=String(msg||"Erreur");
  setTimeout(()=>{$("err").style.display="none";}, 6500);
}
function fmtHTG(n){
  const x = Number(n||0);
  return x.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2}) + " HTG";
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function norm(s){ return String(s||"").toLowerCase().trim(); }

/***************
 * Admin key auto
 ***************/
function getAdminKey(){
  const saved = localStorage.getItem(LS_ADMIN_KEY);
  return (saved && saved.trim()) ? saved.trim() : DEFAULT_ADMIN_KEY;
}
function setAdminKey(v){
  localStorage.setItem(LS_ADMIN_KEY, String(v||"").trim());
}

/***************
 * WhatsApp helpers (CLIENT)
 ***************/
function digitsOnlyPhone(raw){
  let d = String(raw||"").replace(/\D/g,"");
  if(d.length === 8) d = DEFAULT_COUNTRY_CODE + d;
  return d;
}
function openWhatsAppToClient(phone, message){
  const p = digitsOnlyPhone(phone);
  if(!p){
    showErr("Téléphone client invalide.");
    return;
  }
  const url = "https://wa.me/" + p + "?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}

/***************
 * Tabs
 ***************/
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    $("tab-orders").style.display   = (tab==="orders") ? "block" : "none";
    $("tab-products").style.display = (tab==="products") ? "block" : "none";
    $("tab-place").style.display    = (tab==="place") ? "block" : "none";

    if(tab==="orders") loadOrders();
    if(tab==="products") { loadCategories(); loadProducts(); }
    if(tab==="place") loadMenuForPlace();
  });
});

$("refreshBtn").addEventListener("click", ()=>{
  const active = document.querySelector(".tab.active")?.dataset?.tab || "orders";
  if(active==="orders") loadOrders();
  if(active==="products") { loadCategories(); loadProducts(); }
  if(active==="place") loadMenuForPlace();
});
$("statusFilter").addEventListener("change", loadOrders);

/* ✅ recherche ID : filtre + reload */
$("orderIdSearch").addEventListener("input", ()=>{
  // filtre local instantané (pas besoin d’attendre l’API)
  renderOrdersTable(lastOrdersCache);
});

/***************
 * Orders (tri + livré)
 ***************/
let prevOrderIds = new Set();
let lastOrdersCache = [];

function rowClassForStatus(status){
  const st = norm(status);
  if(st.includes("annul")) return "is-cancel";
  if(st.includes("prêt") || st.includes("pret")) return "is-working";
  if(st.includes("reç") || st.includes("recu") || st.includes("reçue")) return "is-received";
  return "";
}

/* ✅ tri : non-livré en haut, livré en bas, puis date desc */
function sortOrdersForDisplay(list){
  const clone = [...(list||[])];
  clone.sort((a,b)=>{
    const aDelivered = norm(a.Statut) === "livré";
    const bDelivered = norm(b.Statut) === "livré";
    if(aDelivered !== bDelivered) return aDelivered ? 1 : -1; // livré => bas
    // date desc
    return String(b.DateHeure||"").localeCompare(String(a.DateHeure||""));
  });
  return clone;
}

/* ✅ filtre ID */
function filterOrdersBySearch(list){
  const q = String($("orderIdSearch").value||"").trim();
  if(!q) return list;
  return (list||[]).filter(o => String(o.OrderID||"").includes(q));
}

async function loadOrders(){
  try{
    const k = $("adminKey").value.trim();
    const status = $("statusFilter").value.trim();
    const orderId = $("orderIdSearch").value.trim();

    const r = await apiJsonp("admin_listOrders", { k, limit:"200", status, orderId });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_listOrders");

    const orders = Array.isArray(r.orders) ? r.orders : [];
    lastOrdersCache = orders;

    renderOrdersTable(orders);

  }catch(e){
    showErr(e.message || e);
    $("ordersTbody").innerHTML = `<tr><td colspan="9" class="muted">Erreur de chargement.</td></tr>`;
  }
}

function renderOrdersTable(ordersRaw){
  const tb = $("ordersTbody");

  // 1) filtre recherche
  let orders = filterOrdersBySearch(ordersRaw);

  // 2) tri (non livré en haut, livré en bas, récent en haut)
  orders = sortOrdersForDisplay(orders);

  if(orders.length===0){
    tb.innerHTML = `<tr><td colspan="9" class="muted">Aucune commande.</td></tr>`;
    prevOrderIds = new Set();
    return;
  }

  const currentIds = new Set(orders.map(o=>String(o.OrderID||"").trim()).filter(Boolean));

  tb.innerHTML = orders.map(o=>{
    const type = o.TypeCommande || "";
    const isSurPlace = /sur\s*place/i.test(type);
    const isEmporter = /(à|a)\s*emporter/i.test(type);

    const st = (o.Statut || "-");
    const badgeClass =
      /annul/i.test(st) ? "badge bad" :
      /livré/i.test(st) ? "badge good" :
      /prêt|pret/i.test(st) ? "badge good" :
      /reç|recu/i.test(st) ? "badge warn" : "badge";

    const safeOrderJson = JSON.stringify(o).replace(/</g,"\\u003c");
    const oid = String(o.OrderID||"").trim();

    const isNew = (!prevOrderIds.has(oid)) && (/reç|recu/i.test(st));
    const trClass = (isNew ? "is-new " : "") + rowClassForStatus(st);

    const deliveredChecked = /livré/i.test(st);

    return `
      <tr class="${trClass}">
        <td>${escapeHtml(o.DateHeure || "")}</td>
        <td class="idCell">${escapeHtml(oid)}</td>
        <td><b>${escapeHtml(o.ClientNom || "")}</b><div class="muted">${escapeHtml(o.Telephone || "")}</div></td>
        <td>${escapeHtml(type)}</td>
        <td>${escapeHtml((o.ResumeItems||"") + "")}</td>
        <td><b>${fmtHTG(o.Total||0)}</b></td>
        <td><span class="${badgeClass}">${escapeHtml(st)}</span></td>

        <!-- ✅ checkbox livré -->
        <td>
          <label class="deliveredBox">
            <input type="checkbox" ${deliveredChecked ? "checked" : ""} onchange="toggleDelivered('${oid.replace(/'/g,"")}', this.checked)">
            Livré
          </label>
        </td>

        <td>
          <div class="actions">
            ${isSurPlace ? `
              <button class="btn good" type="button" onclick='readyConsume(${safeOrderJson})'>Prêt à consommer</button>
            ` : ``}

            ${isEmporter ? `
              <button class="btn good" type="button" onclick='readyTakeaway(${safeOrderJson})'>Prêt à emporter</button>
            ` : ``}

            ${/livraison/i.test(type) ? `
              <button class="btn good" type="button" onclick='readyDeliver(${safeOrderJson})'>Prêt à livrer</button>
            ` : ``}

            <button class="btn" type="button" onclick='printPOS80(${safeOrderJson})'>Imprimer 80mm</button>

            <button class="btn bad" type="button" onclick="setStatus('${oid.replace(/'/g,"")}', 'Annuler')">Annuler</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  prevOrderIds = currentIds;
}

/* ✅ coche livré => statut Livré / si décoché => Reçue (ou tu peux choisir autre) */
window.toggleDelivered = async function(orderId, isDelivered){
  try{
    const nextStatus = isDelivered ? "Livré" : "Reçue";
    await setStatus(orderId, nextStatus);
    toast(isDelivered ? "Marqué livré ✅" : "Remis en Reçue ✅");
    // reload pour re-trier (livré descend)
    loadOrders();
  }catch(e){
    showErr(e.message || e);
  }
};

window.setStatus = async function(orderId, status){
  try{
    const k = $("adminKey").value.trim();
    const r = await apiJsonp("admin_setOrderStatus", { k, orderId, status });
    if(!r || !r.ok) throw new Error(r?.error || "Erreur admin_setOrderStatus");
  }catch(e){
    showErr(e.message || e);
    throw e;
  }
};

window.readyConsume = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Prêt à consommer");
    toast("Statut mis à jour ✅");
    loadOrders();
    openWhatsAppToClient(order.Telephone, "Votre commande est prête à consommer. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

window.readyTakeaway = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Prêt à emporter");
    toast("Statut mis à jour ✅");
    loadOrders();
    openWhatsAppToClient(order.Telephone, "Votre commande est prête à emporter. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

window.readyDeliver = async function(order){
  try{
    const oid = String(order.OrderID||"").trim();
    if(!oid) throw new Error("OrderID manquant");
    await setStatus(oid, "Prêt à livrer");
    toast("Statut mis à jour ✅");
    loadOrders();
    openWhatsAppToClient(order.Telephone, "Votre commande est prête à livrer. Merci d'avoir choisi Bes Fast Food!");
  }catch(e){
    showErr(e.message || e);
  }
};

/***************
 * Print POS 80mm (✅ Livraison conditionnelle)
 ***************/
window.printPOS80 = function(order){
  try{
    const items = Array.isArray(order.items) ? order.items : [];
    const resume = String(order.ResumeItems||"").trim();
    const isLiv = /livraison/i.test(String(order.TypeCommande||""));

    const subTotal = Number(order.SubTotal ?? 0);
    const deliveryFee = Number(order.DeliveryFee ?? 0);

    const rows = items.length
      ? items.map(i=>{
          const name = escapeHtml(i.Nom||"");
          const q = Number(i.Quantite||0);
          const st = fmtHTG(i.SousTotal||0);
          return `<tr><td class="name">${name}</td><td class="qty">${q}</td><td class="amt">${st}</td></tr>`;
        }).join("")
      : `<tr><td colspan="3">${escapeHtml(resume || "-")}</td></tr>`;

    const w = window.open("", "_blank", "width=420,height=820");
    if(!w) { showErr("Popup bloqué (impression)."); return; }

    const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>POS 80mm</title>
<style>
@page { size: 80mm auto; margin: 6mm; }
body{
  width:80mm;
  font-family: Arial, sans-serif;
  margin:0;
  color:#000;
  font-size:14px;
}
h1{ text-align:center; font-size:20px; margin:0 0 4px 0; }
.small{ font-size:13px; }
.hr{ border-top:1px dashed #000; margin:10px 0; }
table{ width:100%; border-collapse:collapse; font-size:14px; }
td{ padding:5px 0; }
td.qty{ width:18mm; text-align:right; font-weight:700; }
td.amt{ width:28mm; text-align:right; font-weight:700; }
.footer{ text-align:center; margin-top:10px; font-size:13px; }

.driverBox{
  margin-top:10px;
  border:2px solid #000;
  padding:8px;
}
.driverTitle{
  font-size:16px;
  font-weight:900;
  text-align:center;
  margin-bottom:6px;
}
.driverLine{
  font-size:16px;
  font-weight:900;
  margin:4px 0;
}
.driverLabel{
  display:inline-block;
  min-width:18mm;
}
</style>
</head>
<body>
<h1>BES FAST FOOD</h1>
<div class="small">
  <div><b>Date:</b> ${escapeHtml(order.DateHeure||"")}</div>
  <div><b>ID:</b> ${escapeHtml(order.OrderID||"")}</div>
  <div><b>Client:</b> ${escapeHtml(order.ClientNom||"")}</div>
  <div><b>Tél:</b> ${escapeHtml(order.Telephone||"")}</div>
  <div><b>Type:</b> ${escapeHtml(order.TypeCommande||"")}</div>
  ${isLiv && order.Adresse ? `<div><b>Adresse:</b> ${escapeHtml(order.Adresse||"")}</div>` : ``}
</div>

<div class="hr"></div>

<table><tbody>${rows}</tbody></table>

<div class="hr"></div>

${isLiv ? `
  <div class="small"><b>Sous-total:</b> ${fmtHTG(subTotal)}</div>
  <div class="small"><b>Frais livraison:</b> ${fmtHTG(deliveryFee)}</div>
  <div class="small"><b>Total:</b> ${fmtHTG(order.Total||0)}</div>

  <div class="driverBox">
    <div class="driverTitle">RÉSUMÉ LIVREUR</div>
    <div class="driverLine"><span class="driverLabel">NOM:</span> ${escapeHtml(order.ClientNom||"")}</div>
    <div class="driverLine"><span class="driverLabel">TEL:</span> ${escapeHtml(order.Telephone||"")}</div>
    <div class="driverLine"><span class="driverLabel">ADR:</span> ${escapeHtml(order.Adresse||"-")}</div>
  </div>
` : `
  <div class="small"><b>Total:</b> ${fmtHTG(order.Total||0)}</div>
`}

<div class="footer small">Merci d'avoir choisi BES Fast Food</div>
<script>window.onload=function(){ window.print(); }<\/script>
</body>
</html>`;

    w.document.open();
    w.document.write(html);
    w.document.close();

  }catch(e){
    showErr("Impression: " + (e.message || e));
  }
};

/***************
 * Products / place order (inchangé)
 * (=> garde ton code existant ici)
 ***************/

/* --- ton code produits + place order reste identique --- */
/* Pour garder la réponse lisible, je n’ai pas ré-écrit toute la partie produits/place ici.
   Tu peux conserver exactement ce que tu avais après printPOS80.
   Si tu veux je te renvoie un fichier 100% complet “copier-coller” avec TOUT jusqu’au bas. */

</script>
</body>
</html>

