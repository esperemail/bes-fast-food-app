<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BES Fast Food - Commande</title>

<style>
:root{
  --y:#FFC107; --o:#FF9800; --r:#D32F2F; --g:#2E7D32;
  --bg:#fff7e6; --card:#fff; --muted:#6b7280;
  --radius:18px; --shadow:0 12px 30px rgba(0,0,0,.12);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
}
header{
  background:linear-gradient(90deg,var(--y),var(--o));
  padding:14px;
}
.topbar{
  max-width:1100px;margin:auto;
  display:flex;align-items:center;justify-content:space-between;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:54px;height:54px;border-radius:14px;
  background:#fff;display:flex;align-items:center;justify-content:center;
  font-weight:900;
}
.wrap{max-width:1100px;margin:auto;padding:16px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
}
.muted{color:var(--muted);font-size:13px}
input,select,textarea{
  width:100%;padding:10px;border-radius:12px;
  border:1px solid #ddd;font-size:14px;
}
button{
  padding:12px;border-radius:14px;
  border:none;font-weight:900;cursor:pointer;
}
.btnPrimary{
  background:var(--r);color:#fff;
}
.btnGhost{
  background:#eee;
}
.hr{height:1px;background:#eee;margin:12px 0}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">BES</div>
      <b>Fast Food</b>
    </div>
    <div class="muted">Commande en ligne rapide et pro</div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- MENU -->
    <div class="card">
      <h3>Menu</h3>
      <div id="products" class="muted">Chargement‚Ä¶</div>
    </div>

    <!-- PANIER -->
    <div class="card" id="cartCard">
      <h3>Panier</h3>
      <div id="cartItems" class="muted">Panier vide</div>

      <div class="hr"></div>
      <b>Total : <span id="total">0 HTG</span></b>

      <div class="hr"></div>

      <input id="clientNom" placeholder="Nom">
      <input id="telephone" placeholder="T√©l√©phone">

      <select id="typeCommande">
        <option>Sur place</option>
        <option>√Ä emporter</option>
        <option>Livraison</option>
      </select>

      <textarea id="adresse" placeholder="Adresse livraison (si livraison)"></textarea>

      <select id="paiement">
        <option value="">Paiement</option>
        <option>MonCash</option>
        <option>NatCash</option>
        <option>Cash</option>
        <option>Cr√©dit</option>
      </select>

      <div class="hr"></div>

      <button id="checkoutBtn" class="btnPrimary">Envoyer la commande</button>
      <div id="toast" class="muted"></div>
    </div>

  </div>
</div>
<script>
/* =========================
   CONFIG
========================= */
const WHATSAPP_NUMBER = "50940430164"; // chiffres seulement
const API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec";
const CART_KEY = "bes_cart_v2";

/* =========================
   LIVRAISON: zones + frais
========================= */
const DELIVERY_ZONES = [
  { key:"Madeline", label:"Centre ville - Madeline", fee:250 },
  { key:"BarriereBouteille", label:"Centre ville - Barri√®re Bouteille", fee:250 },
  { key:"HautDuCap", label:"Centre ville - Haut du Cap", fee:350 },
  { key:"QuartierMorin", label:"Centre ville - Quartier Morin", fee:350 },
  { key:"MorneRouge", label:"Centre ville - Morne rouge", fee:500 },
  { key:"Limonade", label:"Centre ville - Limonade", fee:500 }
];

/* =========================
   STATE
========================= */
const state = {
  products: [],
  productsById: new Map(),
  lastOrderPayload: null,
  lastOrderId: ""
};

const $ = (id)=>document.getElementById(id);
const norm = (s)=>String(s||"").toLowerCase().trim();

function fmtHTG(n){
  const x = Number(n||0);
  return x.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}) + " HTG";
}

function toast(msg){
  const t = $("toast");
  t.textContent = String(msg||"");
}

function isLivraison(){
  return norm($("typeCommande").value) === "livraison";
}

function getSelectedZone(){
  const z = $("zoneLivraison");
  if(!z) return null;
  const key = String(z.value||"").trim();
  return DELIVERY_ZONES.find(x => x.key === key) || null;
}

function getDeliveryFee(){
  if(!isLivraison()) return 0;
  const z = getSelectedZone();
  return z ? Number(z.fee||0) : 0;
}

function syncLivraisonUI(){
  const liv = isLivraison();
  $("adresse").style.display = liv ? "block" : "none";
  $("zoneLivraison").style.display = liv ? "block" : "none";
  $("adresse").disabled = !liv;
  $("zoneLivraison").disabled = !liv;

  if(!liv){
    $("adresse").value = "";
    $("zoneLivraison").value = "";
    $("feeBox").style.display = "none";
  }else{
    $("feeBox").style.display = "block";
  }
  renderCart();
}

/* =========================
   CART (localStorage)
========================= */
function loadCart(){
  try{
    const raw = localStorage.getItem(CART_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){ return {}; }
}
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c||{})); }
function clearCart(){ localStorage.removeItem(CART_KEY); }

function productById(pid){
  return state.productsById.get(String(pid)) || null;
}

function cartToItems(cartObj){
  const items = [];
  for(const [pid, qty] of Object.entries(cartObj||{})){
    const p = productById(pid);
    if(!p) continue;
    items.push({
      ProductID: String(p.ProductID),
      Nom: p.Nom,
      Prix: Number(p.Prix||0),
      Quantite: Math.max(1, Number(qty||1))
    });
  }
  return items;
}

function cartSubtotal(cartObj){
  let total = 0;
  for(const [pid, qty] of Object.entries(cartObj||{})){
    const p = productById(pid);
    if(!p) continue;
    total += Number(p.Prix||0) * Math.max(1, Number(qty||1));
  }
  return total;
}

/* =========================
   MENU (UI)
========================= */
function renderProducts(){
  const box = $("products");
  if(!state.products.length){
    box.innerHTML = `<div class="muted">Aucun produit.</div>`;
    return;
  }

  box.innerHTML = state.products.map(p => `
    <div style="padding:10px;border:1px solid #eee;border-radius:14px;margin:10px 0">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
        <div style="min-width:0">
          <div style="font-weight:900">${p.Nom}</div>
          <div class="muted">${p.Description||""}</div>
        </div>
        <div style="font-weight:900;white-space:nowrap">${fmtHTG(p.Prix)}</div>
      </div>
      <button style="margin-top:10px;width:100%;background:#111;color:#fff"
        onclick="addToCart('${String(p.ProductID).replace(/'/g,"")}')">Ajouter au panier</button>
    </div>
  `).join("");
}

window.addToCart = function(productId){
  const cart = loadCart();
  const pid = String(productId);
  cart[pid] = (Number(cart[pid]||0) + 1);
  saveCart(cart);
  renderCart();
  toast("Ajout√© ‚úÖ");
};

window.qty = function(productId, q){
  const cart = loadCart();
  const pid = String(productId);
  const next = Number(q||0);
  if(next <= 0) delete cart[pid];
  else cart[pid] = next;
  saveCart(cart);
  renderCart();
};

function renderCart(){
  const cart = loadCart();
  const items = cartToItems(cart);
  const sub = cartSubtotal(cart);
  const fee = getDeliveryFee();
  const total = sub + fee;

  $("total").textContent = fmtHTG(total);

  // frais livraison + r√©sum√© livreur (SEULEMENT si livraison)
  if(isLivraison()){
    const z = getSelectedZone();
    $("feeBox").style.display = "block";
    $("feeBox").innerHTML = `
      <div style="padding:10px;border-radius:12px;background:#fff6d7;border:1px solid #f2e2a8;margin-top:10px">
        üöö Frais livraison : <b>${fmtHTG(fee)}</b><br>
        üìå Zone : <b>${z ? z.label : "Choisir une zone"}</b>
      </div>
    `;
  }else{
    $("feeBox").style.display = "none";
    $("feeBox").innerHTML = "";
  }

  if(!items.length){
    $("cartItems").innerHTML = `<div class="muted">Panier vide</div>`;
    return;
  }

  $("cartItems").innerHTML = items.map(it=>{
    const line = Number(it.Prix)*Number(it.Quantite);
    return `
      <div style="display:flex;justify-content:space-between;gap:10px;margin:10px 0">
        <div style="min-width:0">
          <div style="font-weight:900">${it.Nom}</div>
          <div class="muted">${fmtHTG(it.Prix)} √ó ${it.Quantite} = <b>${fmtHTG(line)}</b></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btnGhost" onclick="qty('${it.ProductID}',${it.Quantite-1})">‚àí</button>
          <button class="btnGhost" onclick="qty('${it.ProductID}',${it.Quantite+1})">+</button>
        </div>
      </div>
      <div class="hr"></div>
    `;
  }).join("");
}

/* =========================
   API JSONP (Apps Script)
========================= */
function apiJsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const q = new URLSearchParams({ action, callback: cb, ...params }).toString();
    const url = API_URL + "?" + q;

    const s = document.createElement("script");
    s.src = url;
    s.async = true;

    let done = false;
    const timer = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout API"));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      try{ delete window[cb]; }catch(e){}
      try{ s.remove(); }catch(e){}
    }

    window[cb] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("API error / network"));
    };

    document.head.appendChild(s);
  });
}

async function loadMenu(){
  // si API disponible => getMenu
  try{
    const r = await apiJsonp("getMenu", {});
    if(r && r.ok && Array.isArray(r.products)){
      state.products = r.products.map(p => ({
        ProductID: String(p.ProductID ?? p.id ?? "").trim(),
        Nom: String(p.Nom ?? p.name ?? "").trim(),
        Prix: Number(p.Prix ?? p.price ?? 0),
        Description: String(p.Description ?? p.desc ?? "").trim()
      })).filter(p => p.ProductID && p.Nom);

      state.productsById = new Map(state.products.map(p=>[String(p.ProductID), p]));
      renderProducts();
      return;
    }
  }catch(e){
    // fallback
  }

  // fallback local si API indispo
  state.products = [
    {ProductID:"1", Nom:"Wings Simple", Prix:750, Description:"Wings BBQ"},
    {ProductID:"2", Nom:"Gratin√©", Prix:900, Description:"Gratin√© maison"}
  ];
  state.productsById = new Map(state.products.map(p=>[String(p.ProductID), p]));
  renderProducts();
}

/* =========================
   WHATSAPP message (complet)
========================= */
function buildWhatsAppMessage(payload){
  let msg = "üçî BES FAST FOOD ‚Äì NOUVELLE COMMANDE\n\n";
  msg += "üë§ Nom : " + payload.clientNom + "\n";
  msg += "üìû T√©l√©phone : " + payload.telephone + "\n";
  msg += "üìç Type : " + payload.typeCommande + "\n";

  if(norm(payload.typeCommande)==="livraison"){
    msg += "üè† Adresse : " + (payload.adresse || "-") + "\n";
    msg += "üó∫Ô∏è Zone : " + (payload.deliveryZoneLabel || "-") + "\n";
  }

  msg += "\nüõçÔ∏è Produits:\n";
  payload.items.forEach(it=>{
    const line = Number(it.Prix)*Number(it.Quantite);
    msg += "- " + it.Nom + " x" + it.Quantite + " = " + fmtHTG(line) + "\n";
  });

  msg += "\nüßæ Sous-total : " + fmtHTG(payload.subTotal) + "\n";
  if(payload.deliveryFee > 0) msg += "üöö Livraison : " + fmtHTG(payload.deliveryFee) + "\n";
  msg += "üí∞ Total : " + fmtHTG(payload.total) + "\n";
  msg += "üí≥ Paiement : " + payload.paymentMethod + "\n";

  if(payload.noteCommande) msg += "\nüìù Note : " + payload.noteCommande + "\n";
  msg += "\n‚ö†Ô∏è Envoyer la preuve de paiement sur WhatsApp.\n";
  return msg;
}

function openWhatsApp(message){
  const url = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}

/* =========================
   QR TEXT (TOUTES INFOS)
========================= */
function buildQrText(payload, orderId){
  const lines = [];
  lines.push("BES FAST FOOD");
  lines.push("ID: " + (orderId || "LOCAL-" + Date.now()));
  lines.push("Nom: " + payload.clientNom);
  lines.push("Tel: " + payload.telephone);
  lines.push("Type: " + payload.typeCommande);

  if(norm(payload.typeCommande)==="livraison"){
    lines.push("Adresse: " + (payload.adresse || "-"));
    lines.push("Zone: " + (payload.deliveryZoneLabel || payload.deliveryZone || "-"));
    lines.push("Frais livraison: " + fmtHTG(payload.deliveryFee));
  }

  lines.push("Paiement: " + payload.paymentMethod);
  lines.push("Sous-total: " + fmtHTG(payload.subTotal));
  if(payload.deliveryFee>0) lines.push("Livraison: " + fmtHTG(payload.deliveryFee));
  lines.push("Total: " + fmtHTG(payload.total));

  lines.push("Produits:");
  payload.items.forEach(it=>{
    lines.push("- " + it.Nom + " x" + it.Quantite + " (" + fmtHTG(Number(it.Prix)*Number(it.Quantite)) + ")");
  });

  if(payload.noteCommande) lines.push("Note: " + payload.noteCommande);

  return lines.join("\n");
}

/* =========================
   RE√áU IMPRIM√â (conditionnel livraison)
========================= */
function buildReceiptHTML(payload, orderId){
  const isDel = (norm(payload.typeCommande)==="livraison");
  const now = new Date().toLocaleString();

  const itemsRows = payload.items.map(it=>{
    const line = Number(it.Prix)*Number(it.Quantite);
    return `
      <tr>
        <td>${it.Nom} x${it.Quantite}</td>
        <td style="text-align:right">${fmtHTG(line)}</td>
      </tr>
    `;
  }).join("");

  const deliveryRow = isDel ? `
    <tr>
      <td>Livraison (${payload.deliveryZoneLabel || payload.deliveryZone || "-"})</td>
      <td style="text-align:right">${fmtHTG(payload.deliveryFee)}</td>
    </tr>
    <tr>
      <td colspan="2" style="padding-top:6px">
        <b>R√©sum√© livreur</b><br>
        Nom: ${payload.clientNom}<br>
        Tel: ${payload.telephone}<br>
        Adresse: ${payload.adresse || "-"}<br>
        Zone: ${payload.deliveryZoneLabel || "-"}
      </td>
    </tr>
  ` : "";

  return `
<!doctype html>
<html><head>
<meta charset="utf-8"/>
<title>Re√ßu</title>
<style>
  body{width:80mm;margin:0;font-family:Arial,sans-serif;color:#000}
  h1{font-size:14px;text-align:center;margin:6px 0}
  .small{font-size:11px}
  table{width:100%;border-collapse:collapse;font-size:11px}
  td{padding:3px 0;vertical-align:top}
  .hr{border-top:1px dashed #000;margin:6px 0}
</style>
</head>
<body>
  <h1>BES FAST FOOD</h1>
  <div class="small">Date: ${now}</div>
  <div class="small">ID: ${orderId || "LOCAL-" + Date.now()}</div>
  <div class="small">Nom: ${payload.clientNom}</div>
  <div class="small">Tel: ${payload.telephone}</div>
  <div class="small">Type: ${payload.typeCommande}</div>

  ${isDel ? `<div class="small">Adresse: ${payload.adresse || "-"}</div>` : ""}

  <div class="hr"></div>

  <table>
    ${itemsRows}
    <tr><td colspan="2"><div class="hr"></div></td></tr>
    <tr>
      <td>Sous-total</td>
      <td style="text-align:right">${fmtHTG(payload.subTotal)}</td>
    </tr>
    ${deliveryRow}
    <tr>
      <td><b>Total</b></td>
      <td style="text-align:right"><b>${fmtHTG(payload.total)}</b></td>
    </tr>
  </table>

  <div class="hr"></div>
  <div class="small">Paiement: ${payload.paymentMethod}</div>
  ${payload.noteCommande ? `<div class="small">Note: ${payload.noteCommande}</div>` : ""}
  <div class="small" style="margin-top:8px;text-align:center">Merci üôè</div>

  <script>
    window.onload = ()=>{ window.print(); };
  </script>
</body></html>
  `;
}

function printReceipt(){
  const payload = state.lastOrderPayload;
  if(!payload){
    toast("Aucune commande √† imprimer.");
    return;
  }
  const html = buildReceiptHTML(payload, state.lastOrderId);
  const w = window.open("", "_blank");
  if(!w){
    toast("Popup bloqu√©e. Autorise les popups pour imprimer.");
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* =========================
   CHECKOUT (WhatsApp + Sheets + QR + Re√ßu)
========================= */
async function checkout(){
  try{
    toast("");

    const cart = loadCart();
    const items = cartToItems(cart);
    const subTotal = cartSubtotal(cart);

    if(!items.length || subTotal<=0){
      toast("Panier vide.");
      return;
    }

    const clientNom = $("clientNom").value.trim();
    const telephone = $("telephone").value.trim();
    const typeCommande = $("typeCommande").value;
    const adresse = $("adresse").value.trim();
    const noteCommande = ""; // (si tu veux ajouter champ note plus tard)
    const paymentMethod = $("paiement").value;

    if(!clientNom || !telephone){
      toast("Nom et t√©l√©phone obligatoires.");
      return;
    }
    if(!paymentMethod){
      toast("Choisis un mode de paiement.");
      return;
    }

    const liv = isLivraison();
    const zone = liv ? getSelectedZone() : null;
    const deliveryFee = liv ? (zone ? Number(zone.fee||0) : 0) : 0;

    if(liv && !zone){
      toast("Choisis une zone de livraison.");
      return;
    }
    if(liv && !adresse){
      toast("Adresse obligatoire pour livraison.");
      return;
    }

    const total = subTotal + deliveryFee;

    const payload = {
      clientNom, telephone, typeCommande, adresse,
      noteCommande,
      paymentMethod,
      subTotal,
      deliveryFee,
      deliveryZone: zone ? zone.key : "",
      deliveryZoneLabel: zone ? zone.label : "",
      total,
      items
    };

    // 1) WhatsApp
    openWhatsApp(buildWhatsAppMessage(payload));

    // 2) Sheets (facultatif)
    let savedOrderId = "";
    try{
      const r = await apiJsonp("submitOrderLite", { payload: JSON.stringify(payload) });
      if(r && r.ok){
        savedOrderId = String(r.orderId||"");
      }
    }catch(e){}

    // sauvegarde pour re√ßu
    state.lastOrderPayload = payload;
    state.lastOrderId = savedOrderId || ("LOCAL-" + Date.now());

    // 3) QR (toutes infos)
    const qrText = buildQrText(payload, state.lastOrderId);
    openQrModal(qrText); // modal ajout√© en PARTIE 3

    // reset panier
    clearCart();
    renderCart();
    toast("Commande envoy√©e ‚úÖ (QR affich√©)");

  }catch(e){
    toast("Erreur: " + (e.message||e));
  }
}

/* =========================
   QR MODAL hooks (le HTML est en PARTIE 3)
========================= */
function ensureQrModalExists(){
  if(document.getElementById("qrModal")) return;

  // Si la PARTIE 3 n'est pas encore coll√©e, on ne casse pas le site.
  // Le modal sera disponible apr√®s collage complet.
}

function openQrModal(text){
  ensureQrModalExists();
  const modal = document.getElementById("qrModal");
  const img = document.getElementById("qrImg");
  const ta = document.getElementById("qrText");
  if(!modal || !img || !ta){
    // fallback: si le modal n'existe pas, on affiche juste le texte
    toast("QR pr√™t (colle la PARTIE 3 pour afficher le modal).");
    console.log(text);
    return;
  }

  ta.value = text;
  img.src = "https://chart.googleapis.com/chart?cht=qr&chs=260x260&chl=" + encodeURIComponent(text);
  modal.style.display = "block";
}

window.closeQrModal = function(){
  const modal = document.getElementById("qrModal");
  if(modal) modal.style.display = "none";
};

window.copyQrText = async function(){
  try{
    const t = document.getElementById("qrText").value;
    await navigator.clipboard.writeText(t);
    toast("R√©sum√© copi√© ‚úÖ");
  }catch(e){
    toast("Copie impossible (navigateur).");
  }
};

/* =========================
   BOOT
========================= */
(function init(){
  // Inject UI livraison (zone + feeBox) + bouton impression re√ßu
  const adresse = $("adresse");
  const zoneSel = document.createElement("select");
  zoneSel.id = "zoneLivraison";
  zoneSel.innerHTML =
    `<option value="">Zone de livraison‚Ä¶</option>` +
    DELIVERY_ZONES.map(z => `<option value="${z.key}">${z.label} ‚Äî ${fmtHTG(z.fee)}</option>`).join("");
  adresse.insertAdjacentElement("afterend", zoneSel);

  const feeBox = document.createElement("div");
  feeBox.id = "feeBox";
  $("cartCard").insertBefore(feeBox, $("checkoutBtn"));

  const printBtn = document.createElement("button");
  printBtn.id = "printBtn";
  printBtn.className = "btnGhost";
  printBtn.style.marginTop = "10px";
  printBtn.textContent = "Imprimer re√ßu";
  printBtn.onclick = printReceipt;
  $("checkoutBtn").insertAdjacentElement("afterend", printBtn);

  // events
  $("typeCommande").addEventListener("change", syncLivraisonUI);
  $("zoneLivraison").addEventListener("change", renderCart);
  $("checkoutBtn").addEventListener("click", checkout);

  // initial
  loadMenu();
  syncLivraisonUI();
  renderCart();
})();
</script>
<!-- =========================
     QR MODAL (apr√®s </script>)
========================= -->
<div id="qrModal"
  style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:18px;">
  <div
    style="max-width:420px; margin:60px auto; background:#fff; border-radius:18px; padding:16px; border:1px solid rgba(0,0,0,.15);">
    <div style="font-weight:1000; font-size:18px; margin-bottom:6px;">‚úÖ Commande envoy√©e</div>
    <div style="color:#6b7280; font-size:13px; margin-bottom:12px;">Voici ton QR Code (r√©sum√© complet).</div>

    <div style="display:flex; justify-content:center; margin:12px 0;">
      <img id="qrImg" alt="QR Code"
        style="width:260px; height:260px; border-radius:14px; border:1px solid rgba(0,0,0,.12);">
    </div>

    <textarea id="qrText" readonly style="width:100%; min-height:120px; font-size:12px;"></textarea>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button type="button" class="btnGhost" onclick="closeQrModal()">Fermer</button>
      <button type="button" class="btnPrimary" onclick="copyQrText()">Copier r√©sum√©</button>
    </div>
  </div>
</div>

</body>
</html>
