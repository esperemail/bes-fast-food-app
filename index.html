<script>
/* =========================
   CONFIG
========================= */
const WHATSAPP_NUMBER = "50940430164"; // chiffres seulement
const API_URL = "https://script.google.com/macros/s/AKfycbzQshvQz_slq9esRqHODdW0bWSPz-_a7RqsSGtOuKCK9Wru3_Dj6pRGZCE2NqMFhe8_/exec";
const CART_KEY = "bes_cart_v2";

/* =========================
   LIVRAISON: zones + frais
========================= */
const DELIVERY_ZONES = [
  { key:"Madeline", label:"Centre ville - Madeline", fee:250 },
  { key:"BarriereBouteille", label:"Centre ville - Barri√®re Bouteille", fee:250 },
  { key:"HautDuCap", label:"Centre ville - Haut du Cap", fee:350 },
  { key:"QuartierMorin", label:"Centre ville - Quartier Morin", fee:350 },
  { key:"MorneRouge", label:"Centre ville - Morne rouge", fee:500 },
  { key:"Limonade", label:"Centre ville - Limonade", fee:500 }
];

/* =========================
   STATE
========================= */
const state = {
  products: [],
  productsById: new Map(),
  lastOrderPayload: null,
  lastOrderId: ""
};

/* =========================
   HELPERS
========================= */
const $ = (id)=>document.getElementById(id);
const norm = (s)=>String(s||"").toLowerCase().trim();

function fmtHTG(n){
  const x = Number(n||0);
  return x.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}) + " HTG";
}

function toast(msg){
  const t = $("toast");
  if(!t) return;
  t.textContent = String(msg||"");
  // si ton CSS mettait display:none, on l'affiche
  t.style.display = (msg ? "block" : "none");
}
</script>
<script>
/* =========================
   LIVRAISON helpers
========================= */
function isLivraison(){
  const tc = $("typeCommande");
  return tc ? (norm(tc.value) === "livraison") : false;
}

function getZoneSelect(){
  return $("zoneLivraison"); // existe dans ton HTML (ou inject√© plus bas)
}

function getSelectedZone(){
  const z = getZoneSelect();
  if(!z) return null;
  const key = String(z.value||"").trim();
  return DELIVERY_ZONES.find(x => x.key === key) || null;
}

function getDeliveryFee(){
  if(!isLivraison()) return 0;
  const z = getSelectedZone();
  return z ? Number(z.fee||0) : 0;
}

function ensureFeeBox(){
  let fb = $("feeBox");
  if(fb) return fb;

  // si pas dans HTML, on le cr√©e proche du total si possible
  fb = document.createElement("div");
  fb.id = "feeBox";

  // essaye de le placer avant le bouton checkout, sinon √† la fin du cart
  const checkoutBtn = $("checkoutBtn");
  if(checkoutBtn && checkoutBtn.parentElement){
    checkoutBtn.parentElement.insertBefore(fb, checkoutBtn);
  }else{
    const cart = $("cartCard") || document.body;
    cart.appendChild(fb);
  }
  return fb;
}

function syncLivraisonUI(){
  const liv = isLivraison();

  // meilleur: si tu as un wrapper addrWrap, on l'utilise
  const wrap = $("addrWrap");
  const adresse = $("adresse");
  const zoneSel = getZoneSelect();

  if(wrap){
    wrap.style.display = liv ? "block" : "none";
  }else{
    // fallback: on cache/affiche les champs individuellement
    if(adresse) adresse.style.display = liv ? "block" : "none";
    if(zoneSel) zoneSel.style.display = liv ? "block" : "none";
  }

  if(adresse) adresse.disabled = !liv;
  if(zoneSel) zoneSel.disabled = !liv;

  if(!liv){
    if(adresse) adresse.value = "";
    if(zoneSel) zoneSel.value = "";
  }

  // feeBox UI
  const fb = ensureFeeBox();
  if(!liv){
    fb.style.display = "none";
    fb.innerHTML = "";
  }else{
    fb.style.display = "block";
  }

  renderCart();
}
</script>
<script>
/* =========================
   LIVRAISON helpers
========================= */
function isLivraison(){
  const tc = $("typeCommande");
  return tc ? (norm(tc.value) === "livraison") : false;
}

function getZoneSelect(){
  return $("zoneLivraison"); // existe dans ton HTML (ou inject√© plus bas)
}

function getSelectedZone(){
  const z = getZoneSelect();
  if(!z) return null;
  const key = String(z.value||"").trim();
  return DELIVERY_ZONES.find(x => x.key === key) || null;
}

function getDeliveryFee(){
  if(!isLivraison()) return 0;
  const z = getSelectedZone();
  return z ? Number(z.fee||0) : 0;
}

function ensureFeeBox(){
  let fb = $("feeBox");
  if(fb) return fb;

  // si pas dans HTML, on le cr√©e proche du total si possible
  fb = document.createElement("div");
  fb.id = "feeBox";

  // essaye de le placer avant le bouton checkout, sinon √† la fin du cart
  const checkoutBtn = $("checkoutBtn");
  if(checkoutBtn && checkoutBtn.parentElement){
    checkoutBtn.parentElement.insertBefore(fb, checkoutBtn);
  }else{
    const cart = $("cartCard") || document.body;
    cart.appendChild(fb);
  }
  return fb;
}

function syncLivraisonUI(){
  const liv = isLivraison();

  // meilleur: si tu as un wrapper addrWrap, on l'utilise
  const wrap = $("addrWrap");
  const adresse = $("adresse");
  const zoneSel = getZoneSelect();

  if(wrap){
    wrap.style.display = liv ? "block" : "none";
  }else{
    // fallback: on cache/affiche les champs individuellement
    if(adresse) adresse.style.display = liv ? "block" : "none";
    if(zoneSel) zoneSel.style.display = liv ? "block" : "none";
  }

  if(adresse) adresse.disabled = !liv;
  if(zoneSel) zoneSel.disabled = !liv;

  if(!liv){
    if(adresse) adresse.value = "";
    if(zoneSel) zoneSel.value = "";
  }

  // feeBox UI
  const fb = ensureFeeBox();
  if(!liv){
    fb.style.display = "none";
    fb.innerHTML = "";
  }else{
    fb.style.display = "block";
  }

  renderCart();
}
</script>
<script>
/* =========================
   CART UI + frais livraison
========================= */
function renderCart(){
  const totalEl = $("total");
  const cartItemsEl = $("cartItems");
  if(!totalEl || !cartItemsEl) return;

  const cart = loadCart();
  const items = cartToItems(cart);
  const sub = cartSubtotal(cart);
  const fee = getDeliveryFee();
  const total = sub + fee;

  totalEl.textContent = fmtHTG(total);

  // frais livraison (SEULEMENT si livraison)
  const fb = ensureFeeBox();
  if(isLivraison()){
    const z = getSelectedZone();
    fb.style.display = "block";
    fb.innerHTML = `
      <div style="padding:10px;border-radius:12px;background:#fff6d7;border:1px solid #f2e2a8;margin-top:10px">
        üöö Frais livraison : <b>${fmtHTG(fee)}</b><br>
        üìå Zone : <b>${z ? z.label : "Choisir une zone"}</b>
      </div>
    `;
  }else{
    fb.style.display = "none";
    fb.innerHTML = "";
  }

  if(!items.length){
    cartItemsEl.innerHTML = `<div class="muted">Panier vide</div>`;
    return;
  }

  cartItemsEl.innerHTML = items.map(it=>{
    const line = Number(it.Prix)*Number(it.Quantite);
    return `
      <div style="display:flex;justify-content:space-between;gap:10px;margin:10px 0">
        <div style="min-width:0">
          <div style="font-weight:900">${it.Nom}</div>
          <div class="muted">${fmtHTG(it.Prix)} √ó ${it.Quantite} = <b>${fmtHTG(line)}</b></div>
        </div>
        <div style="display:flex;gap:8px">
          <button type="button" class="btnGhost" onclick="qty('${it.ProductID}',${it.Quantite-1})">‚àí</button>
          <button type="button" class="btnGhost" onclick="qty('${it.ProductID}',${it.Quantite+1})">+</button>
        </div>
      </div>
      <div class="hr"></div>
    `;
  }).join("");
}
</script>
<script>
/* =========================
   API JSONP (Apps Script)
========================= */
function apiJsonp(action, params = {}) {
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const q = new URLSearchParams({ action, callback: cb, ...params }).toString();
    const url = API_URL + "?" + q;

    const s = document.createElement("script");
    s.src = url;
    s.async = true;

    let done = false;
    const timer = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("Timeout API"));
    }, 15000);

    function cleanup(){
      clearTimeout(timer);
      try{ delete window[cb]; }catch(e){}
      try{ s.remove(); }catch(e){}
    }

    window[cb] = (data) => {
      if(done) return;
      done = true;
      cleanup();
      resolve(data);
    };

    s.onerror = () => {
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("API error / network"));
    };

    document.head.appendChild(s);
  });
}

async function loadMenu(){
  try{
    const r = await apiJsonp("getMenu", {});
    if(r && r.ok && Array.isArray(r.products)){
      state.products = r.products.map(p => ({
        ProductID: String(p.ProductID ?? p.id ?? "").trim(),
        Nom: String(p.Nom ?? p.name ?? "").trim(),
        Prix: Number(p.Prix ?? p.price ?? 0),
        Description: String(p.Description ?? p.desc ?? "").trim()
      })).filter(p => p.ProductID && p.Nom);

      state.productsById = new Map(state.products.map(p=>[String(p.ProductID), p]));
      renderProducts();
      return;
    }
  }catch(e){
    // fallback
  }

  // fallback local
  state.products = [
    {ProductID:"1", Nom:"Wings Simple", Prix:750, Description:"Wings BBQ"},
    {ProductID:"2", Nom:"Gratin√©", Prix:900, Description:"Gratin√© maison"}
  ];
  state.productsById = new Map(state.products.map(p=>[String(p.ProductID), p]));
  renderProducts();
}

/* =========================
   Paiement (corrig√©)
   - supporte radios name="pay"
   - supporte aussi select id="paiement" si tu l'as
========================= */
function getPaymentMethod(){
  // 1) radio
  const r = document.querySelector("input[name='pay']:checked");
  if(r) return String(r.value||"").trim();

  // 2) select
  const s = $("paiement");
  if(s) return String(s.value||"").trim();

  return "";
}

function getNoteCommande(){
  const n = $("noteCommande");
  return n ? String(n.value||"").trim() : "";
}
</script>
<script>
/* =========================
   WhatsApp + QR + Re√ßu
========================= */
function buildWhatsAppMessage(payload){
  let msg = "üçî BES FAST FOOD ‚Äì NOUVELLE COMMANDE\n\n";
  msg += "üë§ Nom : " + payload.clientNom + "\n";
  msg += "üìû T√©l√©phone : " + payload.telephone + "\n";
  msg += "üìç Type : " + payload.typeCommande + "\n";

  if(norm(payload.typeCommande)==="livraison"){
    msg += "üè† Adresse : " + (payload.adresse || "-") + "\n";
    msg += "üó∫Ô∏è Zone : " + (payload.deliveryZoneLabel || "-") + "\n";
  }

  msg += "\nüõçÔ∏è Produits:\n";
  payload.items.forEach(it=>{
    const line = Number(it.Prix)*Number(it.Quantite);
    msg += "- " + it.Nom + " x" + it.Quantite + " = " + fmtHTG(line) + "\n";
  });

  msg += "\nüßæ Sous-total : " + fmtHTG(payload.subTotal) + "\n";
  if(payload.deliveryFee > 0) msg += "üöö Livraison : " + fmtHTG(payload.deliveryFee) + "\n";
  msg += "üí∞ Total : " + fmtHTG(payload.total) + "\n";
  msg += "üí≥ Paiement : " + payload.paymentMethod + "\n";

  if(payload.noteCommande) msg += "\nüìù Note : " + payload.noteCommande + "\n";
  msg += "\n‚ö†Ô∏è Envoyer la preuve de paiement sur WhatsApp.\n";
  return msg;
}

function openWhatsApp(message){
  const url = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}

function buildQrText(payload, orderId){
  const lines = [];
  lines.push("BES FAST FOOD");
  lines.push("ID: " + (orderId || "LOCAL-" + Date.now()));
  lines.push("Nom: " + payload.clientNom);
  lines.push("Tel: " + payload.telephone);
  lines.push("Type: " + payload.typeCommande);

  if(norm(payload.typeCommande)==="livraison"){
    lines.push("Adresse: " + (payload.adresse || "-"));
    lines.push("Zone: " + (payload.deliveryZoneLabel || payload.deliveryZone || "-"));
    lines.push("Frais livraison: " + fmtHTG(payload.deliveryFee));
  }

  lines.push("Paiement: " + payload.paymentMethod);
  lines.push("Sous-total: " + fmtHTG(payload.subTotal));
  if(payload.deliveryFee>0) lines.push("Livraison: " + fmtHTG(payload.deliveryFee));
  lines.push("Total: " + fmtHTG(payload.total));

  lines.push("Produits:");
  payload.items.forEach(it=>{
    lines.push("- " + it.Nom + " x" + it.Quantite + " (" + fmtHTG(Number(it.Prix)*Number(it.Quantite)) + ")");
  });

  if(payload.noteCommande) lines.push("Note: " + payload.noteCommande);

  return lines.join("\n");
}

/* =========================
   Re√ßu imprim√© (livraison conditionnelle)
========================= */
function buildReceiptHTML(payload, orderId){
  const isDel = (norm(payload.typeCommande)==="livraison");
  const now = new Date().toLocaleString();

  const itemsRows = payload.items.map(it=>{
    const line = Number(it.Prix)*Number(it.Quantite);
    return `
      <tr>
        <td>${it.Nom} x${it.Quantite}</td>
        <td style="text-align:right">${fmtHTG(line)}</td>
      </tr>
    `;
  }).join("");

  const deliveryRow = isDel ? `
    <tr>
      <td>Livraison (${payload.deliveryZoneLabel || payload.deliveryZone || "-"})</td>
      <td style="text-align:right">${fmtHTG(payload.deliveryFee)}</td>
    </tr>
    <tr>
      <td colspan="2" style="padding-top:6px">
        <b>R√©sum√© livreur</b><br>
        Nom: ${payload.clientNom}<br>
        Tel: ${payload.telephone}<br>
        Adresse: ${payload.adresse || "-"}<br>
        Zone: ${payload.deliveryZoneLabel || "-"}
      </td>
    </tr>
  ` : "";

  return `
<!doctype html>
<html><head>
<meta charset="utf-8"/>
<title>Re√ßu</title>
<style>
  body{width:80mm;margin:0;font-family:Arial,sans-serif;color:#000}
  h1{font-size:14px;text-align:center;margin:6px 0}
  .small{font-size:11px}
  table{width:100%;border-collapse:collapse;font-size:11px}
  td{padding:3px 0;vertical-align:top}
  .hr{border-top:1px dashed #000;margin:6px 0}
</style>
</head>
<body>
  <h1>BES FAST FOOD</h1>
  <div class="small">Date: ${now}</div>
  <div class="small">ID: ${orderId || "LOCAL-" + Date.now()}</div>
  <div class="small">Nom: ${payload.clientNom}</div>
  <div class="small">Tel: ${payload.telephone}</div>
  <div class="small">Type: ${payload.typeCommande}</div>

  ${isDel ? `<div class="small">Adresse: ${payload.adresse || "-"}</div>` : ""}

  <div class="hr"></div>

  <table>
    ${itemsRows}
    <tr><td colspan="2"><div class="hr"></div></td></tr>
    <tr>
      <td>Sous-total</td>
      <td style="text-align:right">${fmtHTG(payload.subTotal)}</td>
    </tr>
    ${deliveryRow}
    <tr>
      <td><b>Total</b></td>
      <td style="text-align:right"><b>${fmtHTG(payload.total)}</b></td>
    </tr>
  </table>

  <div class="hr"></div>
  <div class="small">Paiement: ${payload.paymentMethod}</div>
  ${payload.noteCommande ? `<div class="small">Note: ${payload.noteCommande}</div>` : ""}
  <div class="small" style="margin-top:8px;text-align:center">Merci üôè</div>

  <script>window.onload=()=>{window.print();};</script>
</body></html>
  `;
}

function printReceipt(){
  const payload = state.lastOrderPayload;
  if(!payload){
    toast("Aucune commande √† imprimer.");
    return;
  }
  const html = buildReceiptHTML(payload, state.lastOrderId);
  const w = window.open("", "_blank");
  if(!w){
    toast("Popup bloqu√©e. Autorise les popups pour imprimer.");
    return;
  }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

/* =========================
   QR MODAL (si le HTML existe)
========================= */
function openQrModal(text){
  const modal = document.getElementById("qrModal");
  const img = document.getElementById("qrImg");
  const ta = document.getElementById("qrText");

  if(!modal || !img || !ta){
    // fallback si tu n'as pas encore coll√© le modal HTML
    toast("QR pr√™t ‚úÖ (ajoute le modal QR dans le HTML).");
    console.log(text);
    return;
  }

  ta.value = text;
  img.src = "https://chart.googleapis.com/chart?cht=qr&chs=260x260&chl=" + encodeURIComponent(text);
  modal.style.display = "block";
}

window.closeQrModal = function(){
  const modal = document.getElementById("qrModal");
  if(modal) modal.style.display = "none";
};

window.copyQrText = async function(){
  try{
    const t = document.getElementById("qrText").value;
    await navigator.clipboard.writeText(t);
    toast("R√©sum√© copi√© ‚úÖ");
  }catch(e){
    toast("Copie impossible (navigateur).");
  }
};

/* =========================
   CHECKOUT
========================= */
async function checkout(){
  try{
    toast("");

    const cart = loadCart();
    const items = cartToItems(cart);
    const subTotal = cartSubtotal(cart);

    if(!items.length || subTotal<=0){
      toast("Panier vide.");
      return;
    }

    const clientNom = $("clientNom") ? $("clientNom").value.trim() : "";
    const telephone = $("telephone") ? $("telephone").value.trim() : "";
    const typeCommande = $("typeCommande") ? $("typeCommande").value : "";
    const adresse = $("adresse") ? $("adresse").value.trim() : "";
    const noteCommande = getNoteCommande();
    const paymentMethod = getPaymentMethod();

    if(!clientNom || !telephone){
      toast("Nom et t√©l√©phone obligatoires.");
      return;
    }
    if(!paymentMethod){
      toast("Choisis un mode de paiement.");
      return;
    }

    const liv = isLivraison();
    const zone = liv ? getSelectedZone() : null;
    const deliveryFee = liv ? (zone ? Number(zone.fee||0) : 0) : 0;

    if(liv && !zone){
      toast("Choisis une zone de livraison.");
      return;
    }
    if(liv && !adresse){
      toast("Adresse obligatoire pour livraison.");
      return;
    }

    const total = subTotal + deliveryFee;

    const payload = {
      clientNom, telephone, typeCommande, adresse,
      noteCommande,
      paymentMethod,
      subTotal,
      deliveryFee,
      deliveryZone: zone ? zone.key : "",
      deliveryZoneLabel: zone ? zone.label : "",
      total,
      items
    };

    // 1) WhatsApp
    openWhatsApp(buildWhatsAppMessage(payload));

    // 2) Sheets (facultatif)
    let savedOrderId = "";
    try{
      const r = await apiJsonp("submitOrderLite", { payload: JSON.stringify(payload) });
      if(r && r.ok) savedOrderId = String(r.orderId||"");
    }catch(e){}

    // sauvegarde pour re√ßu
    state.lastOrderPayload = payload;
    state.lastOrderId = savedOrderId || ("LOCAL-" + Date.now());

    // 3) QR (toutes infos)
    const qrText = buildQrText(payload, state.lastOrderId);
    openQrModal(qrText);

    // reset panier
    clearCart();
    renderCart();

    toast("Commande envoy√©e ‚úÖ");

  }catch(e){
    toast("Erreur: " + (e.message||e));
  }
}

/* =========================
   BOOT
========================= */
(function init(){
  // zoneLivraison: si existe d√©j√† dans HTML => on remplit
  const zoneSel = getZoneSelect();
  if(zoneSel){
    if(!zoneSel.dataset.filled){
      zoneSel.innerHTML =
        `<option value="">Zone de livraison‚Ä¶</option>` +
        DELIVERY_ZONES.map(z => `<option value="${z.key}">${z.label} ‚Äî ${fmtHTG(z.fee)}</option>`).join("");
      zoneSel.dataset.filled = "1";
    }
  }

  // feeBox + printBtn
  ensureFeeBox();

  const printBtn = $("printBtn");
  if(printBtn){
    printBtn.addEventListener("click", printReceipt);
  }

  // events
  const tc = $("typeCommande");
  if(tc) tc.addEventListener("change", syncLivraisonUI);
  if(zoneSel) zoneSel.addEventListener("change", renderCart);

  const checkoutBtn = $("checkoutBtn");
  if(checkoutBtn) checkoutBtn.addEventListener("click", checkout);

  // initial
  loadMenu();
  syncLivraisonUI();
  renderCart();
})();
</script>
